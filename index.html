<!DOCTYPE HTML>
<html lang="en">
<head>
	<title>ToDone</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
	<link href="css/font-awesome.min.css" rel="stylesheet">
	<link href="css/style.css" rel="stylesheet">
</head>
<body class="">

	<script type="text/x-underscore-template" id="timestampTemplate">

		<header><%= model.name %></header>

		<div class="datetimes"></div>

		<ul class="tags">
			<li class="tagIcon"><i class="fa fa-tags"></i></li>
			<%= renderTags() %>
			<li class="addTag"><i class="fa fa-plus-square fa-lg"></i></li>
		</ul>

		<i class="fa fa-ellipsis-v fa-fw edit"></i>

	</script>

	<script type="text/x-underscore-template" id="datetimeView0">
		<div class="large">
			<%= renderTimestamp("h:mm") %><span class="soopa"><%= renderTimestamp("a") %></span>
		</div>			
		<div class="small">
			<%= renderTimestamp("MMM Do YYYY") %>, <%= renderTimestamp("fromNow") %>
		</div>
	</script>

	<script type="text/x-underscore-template" id="datetimeView1">
		<div class="large">
			<%= renderTimestamp("MMM Do") %>
		</div>
		<div class="small">
			<%= renderTimestamp("fromNow") %>, <%= renderTimestamp("h:mm a") %>
		</div>
	</script>

	<script type="text/x-underscore-template" id="datetimeView2">
		<div class="med">
			<%= renderTimestamp("fromNow") %>
		</div>			
		<div class="small">
			<%= renderTimestamp("MMM Do YYYY, h:mm a") %>
		</div>
	</script>

	<header class="actionBar">
		<span style="margin:8px;"><i class="fa fa-check-square-o fa-lg"></i> ToDone</span>
		<a href="#" style="float:right;" class=""><i class="fa fa-search fa-2x"></i></a>
	</header>

	<div id="newTimestamp" class="newTimestamp">
		<div class="newTimestampIcon" style="text-align: center; padding: 10px; font-size: 1.2em; border-bottom: dotted 2px #EEE; color: #BF0252;">
			<i class="fa fa-plus"></i> Add Timestamp
		</div>
		<div style="text-align: center; padding: 10px; ">
			Preset: <select>
				<option>Default</option>
				<option>Feeding</option>
			</select>
		</div>
	</div>


	<div class="wrapper" style="margin-top: 150px;"></div>

	<script src="lib/jquery-2.0.3.min.js"></script>
	<script src="lib/underscore.min.js"></script>
	<script src="lib/moment.min.js"></script>
	<script src="js/ls.js"></script>
	<script src="js/eventEmitter.js"></script>
	<script src="js/Timestamp.js"></script>
	<script src="js/TimestampThread.js"></script>
	<script>

		// default config
		// TODO - make this an array of configs that are
		// 		saved/loaded from ls
		var config = {
			model: {
				name: "New Timestamp",
				tags: ["antibiotics", "feeding", "diaper change"]
			},
			display: 2
		};

		$(document).ready(function(){
			// TODO - multiple timestampThreads
			var timestampThread = new TimestampThread(ls.get().timestamps.reverse() || [], $(".wrapper"));
			new TimestampSpawner(timestampThread);
		});

		function uuid() {
			return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
				var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
				return v.toString(16);
			});
		}

		// ehhh still not too happy with this function :/
		function cssAnimate($el, opts){

			var start = opts.start,
				stop = opts.stop,
				cb = opts.callback,
				cssAnims = opts.cssAnims;

			// TODO - return false if required options are absent

			if(start){
				$el.addClass(start);
				setTimeout(function(){
					$el.removeClass(start)
					if(stop) $el.addClass(stop);
				}, 0);
			} else {
				if(stop) $el.addClass(stop);
			}

			// TODO - use event listener instead of timer
			// TODO - return something...?
			setTimeout(function(){
				if(stop) $el.removeClass(stop);
				// TODO - args?
				if(cb) cb();
			}, cssAnims[stop] || 500);
		}

		// TODO - remove this when done testing
		function asplode(){
			localStorage.ToDone = '{"configs": [], "timestamps": []}';
		}

		function popDialog(){
			/*var wrap = $("<div class='dialogWrapper'></div>"),
				dialog = $("<div class='dialog'>asdf</div>");

			wrap.append(dialog);

			$("body").append(wrap);*/
		}
		

		// creates new timestamps in currently selected thread
		// manages configs for new timestamps
		function TimestampSpawner(timestampThread){
			// TODO - template?
			this.$el = $("#newTimestamp");
			// TODO - center on page resize?
			this.center();

			// TODO - list of threads? currently focused thread?
			this.timestampThread = timestampThread;

			// TODO - use proper event map
			this.$el.on("click", ".newTimestampIcon", this.addTimestamp.bind(this));
			$(window).on("scroll", this.trackScroll.bind(this));

			// this is used for trackScroll
			this.originalScrollPos = window.scrollY;
			this.previousScrollPos = window.scrollY;
			this.diff = 0;
			this.backAccumlation = 0;
			this.DEADZONE = 100;
		}

		TimestampSpawner.prototype = {
			constructor: TimestampSpawner,

			// position and size new timestamp junk.
			// HACK - fix this ugly crap
			// 		get rid of magic numbers
			center: function(){
				var MAX_WIDTH = 400,
					BODY_PADDING = 20,
					bodyWidth = $("body").outerWidth(),
					newTimestampWidth = bodyWidth - BODY_PADDING;

				newTimestampWidth = newTimestampWidth > MAX_WIDTH ? MAX_WIDTH : newTimestampWidth;

				this.$el.width(newTimestampWidth).css("margin-left", (bodyWidth * .5) - (newTimestampWidth * .5));
			},

			trackScroll: function(e){

				this.diff = this.previousScrollPos - window.scrollY;
				this.previousScrollPos = window.scrollY;

				// if diff is positive, bring $el into view
				if(this.diff > 0){

					// if were at the top, show regardless
					if(window.scrollY === this.originalScrollPos){
						this.$el.removeClass("out").removeClass("stickied");

					// show only if we've moved backwards enough
					} else if(this.backAccumulation > this.DEADZONE){
						this.$el.removeClass("out").addClass("stickied");
					}

					this.backAccumulation += this.diff;

				// else, hide $el
				} else {
					this.backAccumulation = 0;
					this.$el.addClass("out").removeClass("stickied");
				}
			},

			show: function(){
				// if were at the top, show without sticky
				if(window.scrollY === this.originalScrollPos){
					this.$el.removeClass("out").removeClass("stickied");

				// otherwise, show with sticky
				} else {
					this.$el.removeClass("out").addClass("stickied");
				}
			},

			addTimestamp: function(){
				// TODO - select config based on select value
				var timestamp = this.timestampThread.add(config);
				// TODO - have timestampThread do the prepend/animate?
				$(".wrapper").prepend(timestamp.$el);
				timestamp.animate(null, "enter");
			}

			// this version doesnt perform well on mobile
			// but is more accurate
			/*
			var scrollMug = (function($el){
				var originalVal = window.scrollY,
					prevVal = originalVal,
					newTimestampHeight = $el.outerHeight(),
					originalTop = parseInt($el.css("top")),
					top = originalTop,
					diff = 0;

				return function(e){

					diff = prevVal - window.scrollY;
					top = top + diff;
					prevVal = window.scrollY;

					// console.log(top, prevVal, originalVal);

					// if completely hidden
					if(top < -newTimestampHeight){
						top = -newTimestampHeight;

					// if back at original position
					}else if(top > originalTop){
						top = originalTop;
					}

					// if stickied and not in original position,
					// add stickied class
					if(prevVal !== originalVal && diff > 0){
						$el.addClass("stickied");
					} else {
						$el.removeClass("stickied");
					}

					window.requestAnimationFrame(function(){
						$el.css("top", top + "px");
					});
				}
			})($("#newTimestamp"));*/
		}


	</script>
</body>
</html>